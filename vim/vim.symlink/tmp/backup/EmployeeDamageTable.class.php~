<?php

/**
 * EmployeeDamageTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class EmployeeDamageTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object EmployeeDamageTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('EmployeeDamage');
    }
    public function countEmployeeDamages($employee_id){
      $q = $this->createquery('ed')
        ->where('ed.employee_id = ?', $employee_id);
      return $q->count();
    }
    public function sumEmployeeDamages($employee_id){
      $q = $this->createquery('ed')
        ->select('SUM(ed.cost) AS cost_sum')
        ->where('ed.employee_id = ?', $employee_id);
      $costs = $q->execute();
      return $costs[0]['cost_sum'];
    }
    public function filterEmployee($filters){
      $q = $this->createQuery('ed')
        ->where('ed.employee_id = ?', $filters['employee_id']);
      if(!empty($filters['date_start']['date'])){
        $q->andWhere('ed.date >= ?', $filters['date_start']['date']);
      }
      if(!empty($filters['date_stop']['date'])){
        $q->andWhere('ed.date <= ?', $filters['date_stop']['date']);
      }
      $q->orderBy('ed.date DESC');

      return $q->execute();
    }
    public function filterEmployees($filters){
      $q = $this->createQuery('ed')
        ->leftJoin('ed.Employee e')
        ->select('ed.id, e.id, e.first_name, e.last_name, e.current_stage, ecc.employee_id, COUNT(ed.id) AS count, SUM(ed.cost) AS total_cost')
        ->groupBy('ed.employee_id');
      if(!empty($filters['date_start']['date'])){
        $q->andWhere('ed.date >= ?', $filters['date_start']['date']);
      }
      if(!empty($filters['date_stop']['date'])){
        $q->andWhere('ed.date <= ?', $filters['date_stop']['date']);
      }
      if(!empty($filters['sort']) && $filters['sort'] == 'number'){
        $q->orderBy('count DESC, total_cost DESC');
      } else {
        $q->orderBy('total_cost DESC, count DESC');
      }
      return $q->execute();
    }
}
