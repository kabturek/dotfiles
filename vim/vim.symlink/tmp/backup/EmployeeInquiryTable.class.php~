<?php

/**
 * EmployeeInquiryTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class EmployeeInquiryTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object EmployeeInquiryTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('EmployeeInquiry');
    }

    public function findOrCreate($employee_id, $inquiry_id){
      $q =$this->createQuery('ei')
        ->where('ei.inquiry_id = ?', $inquiry_id)
        ->andWhere('ei.employee_id = ?', $employee_id)
        ->andWhere('ei.is_completed = ?', false);
      $employee_inquiry = $q->fetchOne();
      if(!$employee_inquiry){
        $employee_inquiry = new EmployeeInquiry();
        $employee_inquiry->inquiry_id = $inquiry_id;
        $employee_inquiry->employee_id = $employee_id;
        $employee_inquiry->is_completed = false;
        $employee_inquiry->tries  = 0;
        $employee_inquiry->max_tries  = 3;
        $employee_inquiry->save();
      }
      return $employee_inquiry;
    }

    public function allInquiriesCompleted($employee){
      $inquiry_count = $this->createQuery('ei')
        ->where('ei.employee_id = ?', $employee->id)
        ->count();
      $completed_count = $this->createQuery('ei')
        ->where('ei.employee_id = ?', $employee->id)
        ->andWhere('ei.is_completed = ?', true)
        ->count();
      if($inquiry_count == $completed_count){
        return true;
      }
      return false;
    }
}
